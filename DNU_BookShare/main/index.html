<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNU BookShare - Chia s·∫ª S√°ch Sinh vi√™n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f3f4f6;
            --border: #e5e7eb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-radius: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .logo-text h1 {
            color: var(--dark);
            font-size: 24px;
            font-weight: 700;
        }

        .logo-text p {
            color: #6b7280;
            font-size: 12px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: white;
            color: var(--dark);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Notification Badge */
        .notification-badge {
            position: relative;
            cursor: pointer;
            padding: 8px 12px;
            background: var(--light);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .notification-badge:hover {
            background: var(--border);
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 700;
        }

        /* Search Bar */
        .search-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        select {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            height: fit-content;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-menu li:hover {
            background: var(--light);
            transform: translateX(5px);
        }

        .sidebar-menu li.active {
            background: var(--primary);
            color: white;
        }

        /* Book Grid */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .book-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .book-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .favorite-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s;
        }

        .favorite-btn:hover {
            transform: scale(1.1);
        }

        .favorite-btn.active {
            color: var(--danger);
        }

        .book-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: white;
            position: relative;
        }

        .book-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .badge-new { background: var(--secondary); }
        .badge-borrow { background: var(--primary); }
        .badge-sell { background: var(--warning); }

        .book-info {
            padding: 20px;
        }

        .book-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .book-author {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .book-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .book-condition {
            font-size: 12px;
            color: var(--secondary);
            font-weight: 600;
        }

        .book-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            background: var(--light);
            border-radius: 10px;
            cursor: pointer;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .user-name {
            font-weight: 600;
            color: var(--dark);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
        }

        /* Notification List */
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }

        .notification-item:hover {
            background: var(--light);
        }

        .notification-item.unread {
            background: #eff6ff;
            font-weight: 600;
        }

        .notification-item.unread::before {
            content: '‚óè';
            color: var(--primary);
            margin-right: 10px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 18px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 20px;
            }

            .books-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">üìö</div>
                <div class="logo-text">
                    <h1>DNU BookShare</h1>
                    <p>C·ªông ƒë·ªìng chia s·∫ª s√°ch sinh vi√™n</p>
                </div>
            </div>
            <div class="header-actions" id="headerActions">
                <button class="btn btn-primary" onclick="showModal('loginModal')">ƒêƒÉng nh·∫≠p</button>
                <button class="btn btn-secondary" onclick="showModal('registerModal')">ƒêƒÉng k√Ω</button>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="T√¨m ki·∫øm s√°ch theo t√™n, t√°c gi·∫£, m√¥n h·ªçc...">
                <button class="btn btn-primary" onclick="searchBooks()">üîç T√¨m ki·∫øm</button>
            </div>
            <div class="filter-section">
                <select id="facultyFilter" onchange="searchBooks()">
                    <option value="">T·∫•t c·∫£ khoa</option>
                    <option value="CNTT">C√¥ng ngh·ªá th√¥ng tin</option>
                    <option value="KT">Kinh t·∫ø</option>
                    <option value="NN">Ngo·∫°i ng·ªØ</option>
                    <option value="SP">S∆∞ ph·∫°m</option>
                </select>
                <select id="conditionFilter" onchange="searchBooks()">
                    <option value="">T√¨nh tr·∫°ng</option>
                    <option value="NEW">M·ªõi</option>
                    <option value="LIKE_NEW">Nh∆∞ m·ªõi</option>
                    <option value="GOOD">T·ªët</option>
                    <option value="OLD">C≈©</option>
                </select>
                <select id="typeFilter" onchange="searchBooks()">
                    <option value="">H√¨nh th·ª©c</option>
                    <option value="BORROW">Cho m∆∞·ª£n</option>
                    <option value="SELL">B√°n</option>
                    <option value="EXCHANGE">Trao ƒë·ªïi</option>
                </select>
                <select id="sortFilter" onchange="searchBooks()">
                    <option value="newest">M·ªõi nh·∫•t</option>
                    <option value="popular">Ph·ªï bi·∫øn</option>
                    <option value="price_asc">Gi√° tƒÉng d·∫ßn</option>
                    <option value="price_desc">Gi√° gi·∫£m d·∫ßn</option>
                </select>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <h3 style="margin-bottom: 20px;">Danh m·ª•c</h3>
                <ul class="sidebar-menu">
                    <li class="active" onclick="showSection('home')">üè† Trang ch·ªß</li>
                    <li onclick="showSection('myBooks')">üìñ S√°ch c·ªßa t√¥i</li>
                    <li onclick="showSection('favorites')">‚ù§Ô∏è Y√™u th√≠ch</li>
                    <li onclick="showSection('transactions')">üìù Giao d·ªãch</li>
                    <li onclick="showSection('borrowed')">üìö ƒêang m∆∞·ª£n</li>
                    <li onclick="showSection('notifications')">üîî Th√¥ng b√°o <span id="notifBadge"></span></li>
                    <li onclick="showSection('profile')">üë§ H·ªì s∆°</li>
                    <li onclick="showSection('admin')" id="adminMenu" style="display:none">‚öôÔ∏è Qu·∫£n tr·ªã</li>
                </ul>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div id="booksGrid" class="books-grid">
                    <div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ƒêƒÉng nh·∫≠p</h2>
                <button class="close-btn" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Email sinh vi√™n</label>
                        <input type="email" class="form-control" id="loginEmail" 
                               placeholder="example@dainam.edu.vn" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">M·∫≠t kh·∫©u</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">ƒêƒÉng nh·∫≠p</button>
                    <p style="text-align:center; margin-top:15px; color:#6b7280;">
                        Ch∆∞a c√≥ t√†i kho·∫£n? 
                        <a href="#" onclick="closeModal('loginModal'); showModal('registerModal')" 
                           style="color:var(--primary)">ƒêƒÉng k√Ω ngay</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ƒêƒÉng k√Ω t√†i kho·∫£n</h2>
                <button class="close-btn" onclick="closeModal('registerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label class="form-label">H·ªç v√† t√™n</label>
                        <input type="text" class="form-control" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">M√£ sinh vi√™n</label>
                        <input type="text" class="form-control" id="registerStudentId" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email sinh vi√™n (@dainam.edu.vn)</label>
                        <input type="email" class="form-control" id="registerEmail" 
                               placeholder="example@dainam.edu.vn" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Khoa</label>
                        <select class="form-control" id="registerFaculty" required>
                            <option value="">Ch·ªçn khoa</option>
                            <option value="CNTT">C√¥ng ngh·ªá th√¥ng tin</option>
                            <option value="KT">Kinh t·∫ø</option>
                            <option value="NN">Ngo·∫°i ng·ªØ</option>
                            <option value="SP">S∆∞ ph·∫°m</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">M·∫≠t kh·∫©u</label>
                        <input type="password" class="form-control" id="registerPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                        <input type="password" class="form-control" id="registerConfirmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">ƒêƒÉng k√Ω</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Book Modal -->
    <div class="modal" id="addBookModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ƒêƒÉng s√°ch m·ªõi</h2>
                <button class="close-btn" onclick="closeModal('addBookModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form onsubmit="handleAddBook(event)">
                    <div class="form-group">
                        <label class="form-label">T√™n s√°ch</label>
                        <input type="text" class="form-control" id="bookTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">T√°c gi·∫£</label>
                        <input type="text" class="form-control" id="bookAuthor" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">M√¥n h·ªçc</label>
                        <input type="text" class="form-control" id="bookSubject" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Khoa</label>
                        <select class="form-control" id="bookFaculty" required>
                            <option value="CNTT">C√¥ng ngh·ªá th√¥ng tin</option>
                            <option value="KT">Kinh t·∫ø</option>
                            <option value="NN">Ngo·∫°i ng·ªØ</option>
                            <option value="SP">S∆∞ ph·∫°m</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">M√¥ t·∫£</label>
                        <textarea class="form-control" id="bookDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">T√¨nh tr·∫°ng</label>
                        <select class="form-control" id="bookCondition" required>
                            <option value="NEW">M·ªõi</option>
                            <option value="LIKE_NEW">Nh∆∞ m·ªõi</option>
                            <option value="GOOD">T·ªët</option>
                            <option value="FAIR">Kh√°</option>
                            <option value="OLD">C≈©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">H√¨nh th·ª©c (C√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
                        <div style="display:flex; gap:15px; margin-top:10px;">
                            <label style="display:flex; align-items:center; gap:5px;">
                                <input type="checkbox" id="typeBorrow" value="BORROW">
                                Cho m∆∞·ª£n
                            </label>
                            <label style="display:flex; align-items:center; gap:5px;">
                                <input type="checkbox" id="typeSell" value="SELL">
                                B√°n
                            </label>
                            <label style="display:flex; align-items:center; gap:5px;">
                                <input type="checkbox" id="typeExchange" value="EXCHANGE">
                                Trao ƒë·ªïi
                            </label>
                        </div>
                    </div>
                    <div class="form-group" id="priceGroup" style="display:none;">
                        <label class="form-label">Gi√° b√°n (VNƒê)</label>
                        <input type="number" class="form-control" id="bookPrice">
                    </div>
                    <div class="form-group" id="borrowDaysGroup" style="display:none;">
                        <label class="form-label">S·ªë ng√†y cho m∆∞·ª£n</label>
                        <input type="number" class="form-control" id="bookBorrowDays" value="7">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">ƒêƒÉng s√°ch</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Book Detail Modal -->
    <div class="modal" id="bookDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="detailBookTitle"></h2>
                <button class="close-btn" onclick="closeModal('bookDetailModal')">&times;</button>
            </div>
            <div class="modal-body" id="bookDetailContent">
            </div>
        </div>
    </div>

    <script>
        // Data Storage - s·ª≠ d·ª•ng localStorage ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu l√¢u d√†i
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('users')) || [
            {
                userId: 'admin001',
                email: 'admin@dainam.edu.vn',
                password: 'admin123',
                fullName: 'Admin DNU',
                studentId: 'ADMIN001',
                faculty: 'CNTT',
                role: 'ADMIN',
                trustScore: 5.0,
                favoriteBooks: []
            }
        ];

        let books = JSON.parse(localStorage.getItem('books')) || [
            {
                bookId: 'BOOK001',
                ownerId: 'admin001',
                title: 'L·∫≠p tr√¨nh h∆∞·ªõng ƒë·ªëi t∆∞·ª£ng v·ªõi Java',
                author: 'Nguy·ªÖn VƒÉn A',
                subject: 'L·∫≠p tr√¨nh Java',
                faculty: 'CNTT',
                description: 'S√°ch gi√°o tr√¨nh m√¥n OOP, c√≤n m·ªõi 95%',
                condition: 'LIKE_NEW',
                types: ['BORROW', 'SELL'],
                price: 150000,
                borrowDays: 14,
                status: 'AVAILABLE',
                viewCount: 45,
                isVisible: true
            },
            {
                bookId: 'BOOK002',
                ownerId: 'admin001',
                title: 'C·∫•u tr√∫c d·ªØ li·ªáu v√† gi·∫£i thu·∫≠t',
                author: 'Tr·∫ßn Th·ªã B',
                subject: 'C·∫•u tr√∫c d·ªØ li·ªáu',
                faculty: 'CNTT',
                description: 'S√°ch c≈© nh∆∞ng n·ªôi dung ƒë·∫ßy ƒë·ªß',
                condition: 'GOOD',
                types: ['BORROW'],
                borrowDays: 7,
                status: 'AVAILABLE',
                viewCount: 32,
                isVisible: true
            },
            {
                bookId: 'BOOK003',
                ownerId: 'admin001',
                title: 'Nguy√™n l√Ω Marketing',
                author: 'Philip Kotler',
                subject: 'Marketing',
                faculty: 'KT',
                description: 'S√°ch ch∆∞a d√πng, b·∫£n ti·∫øng Vi·ªát',
                condition: 'NEW',
                types: ['SELL', 'EXCHANGE'],
                price: 200000,
                status: 'AVAILABLE',
                viewCount: 28,
                isVisible: true
            }
        ];

        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];

        // L∆∞u data v√†o localStorage
        function saveData() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('books', JSON.stringify(books));
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('notifications', JSON.stringify(notifications));
            console.log('‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu v√†o localStorage');
        }

        // Initialize
        window.onload = function() {
            // Check if logged in from localStorage
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUIAfterLogin();
            }
            displayBooks();
            updateNotificationBadge();
        };

        // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Authentication
        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.email === email && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                closeModal('loginModal');
                updateUIAfterLogin();
                alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
                displayBooks();
                updateNotificationBadge();
            } else {
                alert('Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!');
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const studentId = document.getElementById('registerStudentId').value;
            const email = document.getElementById('registerEmail').value;
            const faculty = document.getElementById('registerFaculty').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            if (!email.endsWith('@dainam.edu.vn')) {
                alert('Email ph·∫£i c√≥ ƒëu√¥i @dainam.edu.vn');
                return;
            }

            if (password !== confirmPassword) {
                alert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
                return;
            }

            if (users.find(u => u.email === email)) {
                alert('Email ƒë√£ t·ªìn t·∫°i!');
                return;
            }

            const newUser = {
                userId: 'USER' + Date.now(),
                email,
                password,
                fullName: name,
                studentId,
                faculty,
                role: 'STUDENT',
                trustScore: 5.0,
                favoriteBooks: []
            };

            users.push(newUser);
            saveData();
            alert('ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.');
            closeModal('registerModal');
            showModal('loginModal');
        }

        function updateUIAfterLogin() {
            const headerActions = document.getElementById('headerActions');
            headerActions.innerHTML = `
                <div class="notification-badge" onclick="showSection('notifications')">
                    üîî
                    <span class="badge-count" id="headerNotifCount" style="display:none;">0</span>
                </div>
                <button class="btn btn-success" onclick="showModal('addBookModal')">
                    ‚ûï ƒêƒÉng s√°ch
                </button>
                <div class="user-profile" onclick="showSection('profile')">
                    <div class="user-avatar">${currentUser.fullName.charAt(0)}</div>
                    <span class="user-name">${currentUser.fullName}</span>
                </div>
                <button class="btn btn-danger" onclick="handleLogout()">ƒêƒÉng xu·∫•t</button>
            `;

            if (currentUser.role === 'ADMIN') {
                document.getElementById('adminMenu').style.display = 'block';
            }
            
            updateNotificationBadge();
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            location.reload();
        }

        // Update notification badge
        function updateNotificationBadge() {
            if (!currentUser) return;
            
            const unreadNotifs = notifications.filter(n => 
                n.userId === currentUser.userId && !n.isRead
            );
            
            const count = unreadNotifs.length;
            const badge = document.getElementById('notifBadge');
            const headerBadge = document.getElementById('headerNotifCount');
            
            if (count > 0) {
                if (badge) badge.innerHTML = `<span style="background:var(--danger);color:white;padding:2px 6px;border-radius:10px;font-size:11px;margin-left:5px;">${count}</span>`;
                if (headerBadge) {
                    headerBadge.textContent = count;
                    headerBadge.style.display = 'block';
                }
            } else {
                if (badge) badge.innerHTML = '';
                if (headerBadge) headerBadge.style.display = 'none';
            }
        }

        // Toggle favorite
        function toggleFavorite(event, bookId) {
            event.stopPropagation();
            
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            const user = users.find(u => u.userId === currentUser.userId);
            if (!user.favoriteBooks) user.favoriteBooks = [];
            
            const index = user.favoriteBooks.indexOf(bookId);
            if (index > -1) {
                user.favoriteBooks.splice(index, 1);
            } else {
                user.favoriteBooks.push(bookId);
            }
            
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            saveData();
            
            // Re-render if in favorites section
            if (document.querySelector('.sidebar-menu li.active').textContent.includes('Y√™u th√≠ch')) {
                showFavorites();
            } else {
                displayBooks();
            }
        }
        
        // Display Books
        function displayBooks(booksToShow = null) {
            const booksGrid = document.getElementById('booksGrid');
            const displayList = booksToShow || books.filter(b => b.isVisible && b.status === 'AVAILABLE');
            
            if (displayList.length === 0) {
                booksGrid.innerHTML = '<div class="loading">Kh√¥ng t√¨m th·∫•y s√°ch n√†o</div>';
                return;
            }
            
            booksGrid.innerHTML = displayList.map(book => {
                const owner = users.find(u => u.userId === book.ownerId);
                const isFavorite = currentUser && currentUser.favoriteBooks && currentUser.favoriteBooks.includes(book.bookId);
                const conditionText = {
                    'NEW': 'M·ªõi',
                    'LIKE_NEW': 'Nh∆∞ m·ªõi',
                    'GOOD': 'T·ªët',
                    'FAIR': 'Kh√°',
                    'OLD': 'C≈©'
                };
                
                const typeDisplay = book.types.includes('BORROW') ? 
                    '<span class="book-badge badge-borrow">Cho m∆∞·ª£n</span>' :
                    book.types.includes('SELL') ? 
                    '<span class="book-badge badge-sell">B√°n</span>' : 
                    '<span class="book-badge badge-new">Trao ƒë·ªïi</span>';
                
                return `
                    <div class="book-card" onclick="showBookDetail('${book.bookId}')">
                        <button class="favorite-btn ${isFavorite ? 'active' : ''}" 
                                onclick="toggleFavorite(event, '${book.bookId}')">
                            ${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}
                        </button>
                        <div class="book-image">
                            üìñ
                            ${typeDisplay}
                        </div>
                        <div class="book-info">
                            <div class="book-title">${book.title}</div>
                            <div class="book-author">üìù ${book.author}</div>
                            <div class="book-author">üë§ ${owner ? owner.fullName : 'Unknown'}</div>
                            <div class="book-meta">
                                <span class="book-condition">${conditionText[book.condition]}</span>
                                <span class="book-price">${book.price ? book.price.toLocaleString() + ' ƒë' : 'Mi·ªÖn ph√≠'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Search Books
        function searchBooks() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const faculty = document.getElementById('facultyFilter').value;
            const condition = document.getElementById('conditionFilter').value;
            const type = document.getElementById('typeFilter').value;
            const sort = document.getElementById('sortFilter').value;
            
            let filtered = books.filter(book => {
                if (!book.isVisible || book.status !== 'AVAILABLE') return false;
                
                const matchSearch = !searchTerm || 
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm) ||
                    book.subject.toLowerCase().includes(searchTerm);
                    
                const matchFaculty = !faculty || book.faculty === faculty;
                const matchCondition = !condition || book.condition === condition;
                const matchType = !type || book.types.includes(type);
                
                return matchSearch && matchFaculty && matchCondition && matchType;
            });
            
            // Sort
            if (sort === 'newest') {
                filtered.reverse();
            } else if (sort === 'popular') {
                filtered.sort((a, b) => (b.viewCount || 0) - (a.viewCount || 0));
            } else if (sort === 'price_asc') {
                filtered.sort((a, b) => (a.price || 0) - (b.price || 0));
            } else if (sort === 'price_desc') {
                filtered.sort((a, b) => (b.price || 0) - (a.price || 0));
            }
            
            displayBooks(filtered);
        }

        // Show Book Detail
        function showBookDetail(bookId) {
            const book = books.find(b => b.bookId === bookId);
            if (!book) return;
            
            const owner = users.find(u => u.userId === book.ownerId);
            book.viewCount = (book.viewCount || 0) + 1;
            saveData();
            
            const conditionText = {
                'NEW': 'M·ªõi',
                'LIKE_NEW': 'Nh∆∞ m·ªõi',
                'GOOD': 'T·ªët',
                'FAIR': 'Kh√°',
                'OLD': 'C≈©'
            };
            
            const facultyText = {
                'CNTT': 'C√¥ng ngh·ªá th√¥ng tin',
                'KT': 'Kinh t·∫ø',
                'NN': 'Ngo·∫°i ng·ªØ',
                'SP': 'S∆∞ ph·∫°m'
            };
            
            document.getElementById('detailBookTitle').textContent = book.title;
            
            let actionButtons = '';
            if (currentUser && currentUser.userId !== book.ownerId) {
                if (book.types.includes('BORROW')) {
                    actionButtons += `<button class="btn btn-primary" onclick="requestBorrow('${bookId}')">Y√™u c·∫ßu m∆∞·ª£n</button>`;
                }
                if (book.types.includes('SELL')) {
                    actionButtons += `<button class="btn btn-success" onclick="requestBuy('${bookId}')">Mua s√°ch</button>`;
                }
                if (book.types.includes('EXCHANGE')) {
                    actionButtons += `<button class="btn btn-secondary" onclick="requestExchange('${bookId}')">Trao ƒë·ªïi</button>`;
                }
            } else if (currentUser && currentUser.userId === book.ownerId) {
                actionButtons = `
                    <button class="btn btn-warning" onclick="editBook('${bookId}')">S·ª≠a th√¥ng tin</button>
                    <button class="btn btn-danger" onclick="deleteBook('${bookId}')">X√≥a s√°ch</button>
                `;
            }
            
            document.getElementById('bookDetailContent').innerHTML = `
                <div style="display:grid; gap:20px;">
                    <div>
                        <strong>T√°c gi·∫£:</strong> ${book.author}
                    </div>
                    <div>
                        <strong>M√¥n h·ªçc:</strong> ${book.subject}
                    </div>
                    <div>
                        <strong>Khoa:</strong> ${facultyText[book.faculty]}
                    </div>
                    <div>
                        <strong>T√¨nh tr·∫°ng:</strong> <span style="color:var(--secondary)">${conditionText[book.condition]}</span>
                    </div>
                    <div>
                        <strong>H√¨nh th·ª©c:</strong> ${book.types.map(t => {
                            const typeMap = {'BORROW': 'Cho m∆∞·ª£n', 'SELL': 'B√°n', 'EXCHANGE': 'Trao ƒë·ªïi'};
                            return typeMap[t];
                        }).join(', ')}
                    </div>
                    ${book.price ? `<div><strong>Gi√°:</strong> <span style="color:var(--primary);font-size:20px;font-weight:700">${book.price.toLocaleString()} ƒë</span></div>` : ''}
                    ${book.borrowDays ? `<div><strong>S·ªë ng√†y cho m∆∞·ª£n:</strong> ${book.borrowDays} ng√†y</div>` : ''}
                    <div>
                        <strong>Ch·ªß s√°ch:</strong> ${owner ? owner.fullName : 'Unknown'}
                    </div>
                    ${owner ? `<div><strong>ƒê√°nh gi√° t√≠n nhi·ªám:</strong> ‚≠ê ${owner.trustScore}/5.0</div>` : ''}
                    <div>
                        <strong>L∆∞·ª£t xem:</strong> ${book.viewCount || 0}
                    </div>
                    ${book.description ? `<div><strong>M√¥ t·∫£:</strong><p style="margin-top:10px;color:#6b7280;">${book.description}</p></div>` : ''}
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        ${actionButtons}
                    </div>
                </div>
            `;
            
            showModal('bookDetailModal');
        }

        // Add Book
        function handleAddBook(event) {
            event.preventDefault();
            
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            const types = [];
            if (document.getElementById('typeBorrow').checked) types.push('BORROW');
            if (document.getElementById('typeSell').checked) types.push('SELL');
            if (document.getElementById('typeExchange').checked) types.push('EXCHANGE');
            
            if (types.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h√¨nh th·ª©c!');
                return;
            }
            
            const newBook = {
                bookId: 'BOOK' + Date.now(),
                ownerId: currentUser.userId,
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                subject: document.getElementById('bookSubject').value,
                faculty: document.getElementById('bookFaculty').value,
                description: document.getElementById('bookDescription').value,
                condition: document.getElementById('bookCondition').value,
                types: types,
                price: types.includes('SELL') ? parseInt(document.getElementById('bookPrice').value) : null,
                borrowDays: types.includes('BORROW') ? parseInt(document.getElementById('bookBorrowDays').value) : null,
                status: 'AVAILABLE',
                viewCount: 0,
                isVisible: true,
                createdAt: new Date().toISOString()
            };
            
            books.push(newBook);
            saveData();
            
            alert('ƒêƒÉng s√°ch th√†nh c√¥ng!');
            closeModal('addBookModal');
            event.target.reset();
            displayBooks();
        }

        // Toggle price/borrow fields
        document.addEventListener('DOMContentLoaded', function() {
            const typeSell = document.getElementById('typeSell');
            const typeBorrow = document.getElementById('typeBorrow');
            const priceGroup = document.getElementById('priceGroup');
            const borrowDaysGroup = document.getElementById('borrowDaysGroup');
            
            if (typeSell) {
                typeSell.addEventListener('change', function() {
                    priceGroup.style.display = this.checked ? 'block' : 'none';
                });
            }
            
            if (typeBorrow) {
                typeBorrow.addEventListener('change', function() {
                    borrowDaysGroup.style.display = this.checked ? 'block' : 'none';
                });
            }
        });

        // Request actions
        function requestBorrow(bookId) {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            const book = books.find(b => b.bookId === bookId);
            const owner = users.find(u => u.userId === book.ownerId);
            
            const transaction = {
                transactionId: 'TXN' + Date.now(),
                bookId: bookId,
                requesterId: currentUser.userId,
                ownerId: book.ownerId,
                type: 'BORROW',
                status: 'PENDING',
                createdAt: new Date().toISOString()
            };
            
            transactions.push(transaction);
            
            const notification = {
                notificationId: 'NOTIF' + Date.now(),
                userId: book.ownerId,
                message: `${currentUser.fullName} mu·ªën m∆∞·ª£n s√°ch "${book.title}"`,
                type: 'BORROW_REQUEST',
                isRead: false,
                createdAt: new Date().toISOString(),
                relatedId: transaction.transactionId
            };
            
            notifications.push(notification);
            saveData();
            
            alert('ƒê√£ g·ª≠i y√™u c·∫ßu m∆∞·ª£n s√°ch! Vui l√≤ng ch·ªù ch·ªß s√°ch x√°c nh·∫≠n.');
            closeModal('bookDetailModal');
        }

        function requestBuy(bookId) {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            const book = books.find(b => b.bookId === bookId);
            
            const transaction = {
                transactionId: 'TXN' + Date.now(),
                bookId: bookId,
                requesterId: currentUser.userId,
                ownerId: book.ownerId,
                type: 'BUY',
                status: 'PENDING',
                price: book.price,
                createdAt: new Date().toISOString()
            };
            
            transactions.push(transaction);
            
            const notification = {
                notificationId: 'NOTIF' + Date.now(),
                userId: book.ownerId,
                message: `${currentUser.fullName} mu·ªën mua s√°ch "${book.title}" v·ªõi gi√° ${book.price.toLocaleString()} ƒë`,
                type: 'BUY_REQUEST',
                isRead: false,
                createdAt: new Date().toISOString(),
                relatedId: transaction.transactionId
            };
            
            notifications.push(notification);
            saveData();
            
            alert('ƒê√£ g·ª≠i y√™u c·∫ßu mua s√°ch! Vui l√≤ng ch·ªù ch·ªß s√°ch x√°c nh·∫≠n.');
            closeModal('bookDetailModal');
        }

        function requestExchange(bookId) {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            alert('Ch·ª©c nƒÉng trao ƒë·ªïi s√°ch ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        }

        // Section Navigation
        function showSection(section) {
            // Update active menu
            document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
            event.target.classList.add('active');
            
            const contentArea = document.querySelector('.content-area');
            
            switch(section) {
                case 'home':
                    contentArea.innerHTML = '<div id="booksGrid" class="books-grid"></div>';
                    displayBooks();
                    break;
                case 'myBooks':
                    showMyBooks();
                    break;
                case 'favorites':
                    showFavorites();
                    break;
                case 'transactions':
                    showTransactions();
                    break;
                case 'borrowed':
                    showBorrowed();
                    break;
                case 'notifications':
                    showNotifications();
                    break;
                case 'profile':
                    showProfile();
                    break;
                case 'admin':
                    showAdmin();
                    break;
            }
        }

        function showMyBooks() {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            const myBooks = books.filter(b => b.ownerId === currentUser.userId);
            const contentArea = document.querySelector('.content-area');
            
            contentArea.innerHTML = `
                <div>
                    <h2 style="margin-bottom:20px;">S√°ch c·ªßa t√¥i (${myBooks.length})</h2>
                    <div id="booksGrid" class="books-grid"></div>
                </div>
            `;
            
            displayBooks(myBooks);
        }

        function showFavorites() {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            const favoriteBooks = books.filter(b => 
                currentUser.favoriteBooks && currentUser.favoriteBooks.includes(b.bookId)
            );
            
            const contentArea = document.querySelector('.content-area');
            contentArea.innerHTML = `
                <div>
                    <h2 style="margin-bottom:20px;">S√°ch y√™u th√≠ch (${favoriteBooks.length})</h2>
                    <div id="booksGrid" class="books-grid"></div>
                </div>
            `;
            
            displayBooks(favoriteBooks);
        }

        function showTransactions() {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            const myTransactions = transactions.filter(t => 
                t.requesterId === currentUser.userId || t.ownerId === currentUser.userId
            );
            
            const contentArea = document.querySelector('.content-area');
            contentArea.innerHTML = `
                <div style="background:white; padding:30px; border-radius:15px;">
                    <h2 style="margin-bottom:20px;">Giao d·ªãch (${myTransactions.length})</h2>
                    <div id="transactionList"></div>
                </div>
            `;
            
            const transactionList = document.getElementById('transactionList');
            
            if (myTransactions.length === 0) {
                transactionList.innerHTML = '<p style="color:#6b7280; text-align:center; padding:40px;">Ch∆∞a c√≥ giao d·ªãch n√†o</p>';
                return;
            }
            
            transactionList.innerHTML = myTransactions.map(t => {
                const book = books.find(b => b.bookId === t.bookId);
                const otherUser = users.find(u => 
                    u.userId === (t.requesterId === currentUser.userId ? t.ownerId : t.requesterId)
                );
                
                const statusColor = {
                    'PENDING': 'var(--warning)',
                    'APPROVED': 'var(--secondary)',
                    'COMPLETED': 'var(--primary)',
                    'REJECTED': 'var(--danger)'
                };
                
                const statusText = {
                    'PENDING': 'Ch·ªù x√°c nh·∫≠n',
                    'APPROVED': 'ƒê√£ ch·∫•p nh·∫≠n',
                    'COMPLETED': 'Ho√†n th√†nh',
                    'REJECTED': 'ƒê√£ t·ª´ ch·ªëi'
                };
                
                return `
                    <div style="padding:20px; border:2px solid var(--border); border-radius:10px; margin-bottom:15px;">
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div style="flex:1;">
                                <h3 style="margin-bottom:10px;">${book ? book.title : 'S√°ch ƒë√£ x√≥a'}</h3>
                                <p style="color:#6b7280; margin-bottom:5px;">
                                    ${t.requesterId === currentUser.userId ? 'V·ªõi' : 'T·ª´'}: ${otherUser ? otherUser.fullName : 'Unknown'}
                                </p>
                                <p style="color:#6b7280;">Lo·∫°i: ${t.type === 'BORROW' ? 'M∆∞·ª£n s√°ch' : 'Mua s√°ch'}</p>
                                ${t.price ? `<p style="color:var(--primary); font-weight:700; margin-top:5px;">${t.price.toLocaleString()} ƒë</p>` : ''}
                            </div>
                            <div style="text-align:right;">
                                <span style="background:${statusColor[t.status]}; color:white; padding:6px 12px; border-radius:20px; font-size:12px; font-weight:600;">
                                    ${statusText[t.status]}
                                </span>
                                ${t.ownerId === currentUser.userId && t.status === 'PENDING' ? `
                                    <div style="margin-top:15px; display:flex; gap:10px;">
                                        <button class="btn btn-success" style="padding:8px 16px; font-size:12px;" onclick="approveTransaction('${t.transactionId}')">Ch·∫•p nh·∫≠n</button>
                                        <button class="btn btn-danger" style="padding:8px 16px; font-size:12px;" onclick="rejectTransaction('${t.transactionId}')">T·ª´ ch·ªëi</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function approveTransaction(transactionId) {
            const transaction = transactions.find(t => t.transactionId === transactionId);
            transaction.status = 'APPROVED';
            
            const book = books.find(b => b.bookId === transaction.bookId);
            const requester = users.find(u => u.userId === transaction.requesterId);
            
            const notification = {
                notificationId: 'NOTIF' + Date.now(),
                userId: transaction.requesterId,
                message: `Y√™u c·∫ßu ${transaction.type === 'BORROW' ? 'm∆∞·ª£n' : 'mua'} s√°ch "${book.title}" ƒë√£ ƒë∆∞·ª£c ch·∫•p nh·∫≠n!`,
                type: 'TRANSACTION_APPROVED',
                isRead: false,
                createdAt: new Date().toISOString()
            };
            
            notifications.push(notification);
            saveData();
            
            alert('ƒê√£ ch·∫•p nh·∫≠n giao d·ªãch!');
            showTransactions();
        }

        function rejectTransaction(transactionId) {
            const transaction = transactions.find(t => t.transactionId === transactionId);
            transaction.status = 'REJECTED';
            
            const book = books.find(b => b.bookId === transaction.bookId);
            
            const notification = {
                notificationId: 'NOTIF' + Date.now(),
                userId: transaction.requesterId,
                message: `Y√™u c·∫ßu ${transaction.type === 'BORROW' ? 'm∆∞·ª£n' : 'mua'} s√°ch "${book.title}" ƒë√£ b·ªã t·ª´ ch·ªëi`,
                type: 'TRANSACTION_REJECTED',
                isRead: false,
                createdAt: new Date().toISOString()
            };
            
            notifications.push(notification);
            saveData();
            
            alert('ƒê√£ t·ª´ ch·ªëi giao d·ªãch!');
            showTransactions();
        }

        function showBorrowed() {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            const borrowed = transactions.filter(t => 
                t.requesterId === currentUser.userId && 
                t.type === 'BORROW' && 
                t.status === 'APPROVED'
            );
            
            const contentArea = document.querySelector('.content-area');
            contentArea.innerHTML = `
                <div style="background:white; padding:30px; border-radius:15px;">
                    <h2 style="margin-bottom:20px;">S√°ch ƒëang m∆∞·ª£n (${borrowed.length})</h2>
                    <div id="borrowedList"></div>
                </div>
            `;
            
            const borrowedList = document.getElementById('borrowedList');
            
            if (borrowed.length === 0) {
                borrowedList.innerHTML = '<p style="color:#6b7280; text-align:center; padding:40px;">B·∫°n ch∆∞a m∆∞·ª£n s√°ch n√†o</p>';
                return;
            }
            
            borrowedList.innerHTML = borrowed.map(t => {
                const book = books.find(b => b.bookId === t.bookId);
                const owner = users.find(u => u.userId === t.ownerId);
                
                return `
                    <div style="padding:20px; border:2px solid var(--border); border-radius:10px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h3 style="margin-bottom:10px;">${book ? book.title : 'S√°ch ƒë√£ x√≥a'}</h3>
                            <p style="color:#6b7280;">Ch·ªß s√°ch: ${owner ? owner.fullName : 'Unknown'}</p>
                            <p style="color:#6b7280;">S·ªë ng√†y m∆∞·ª£n: ${book ? book.borrowDays : 0} ng√†y</p>
                        </div>
                        <button class="btn btn-primary" onclick="returnBook('${t.transactionId}')">Tr·∫£ s√°ch</button>
                    </div>
                `;
            }).join('');
        }

        function returnBook(transactionId) {
            const transaction = transactions.find(t => t.transactionId === transactionId);
            transaction.status = 'COMPLETED';
            
            const book = books.find(b => b.bookId === transaction.bookId);
            
            const notification = {
                notificationId: 'NOTIF' + Date.now(),
                userId: transaction.ownerId,
                message: `${currentUser.fullName} ƒë√£ tr·∫£ s√°ch "${book.title}"`,
                type: 'BOOK_RETURNED',
                isRead: false,
                createdAt: new Date().toISOString()
            };
            
            notifications.push(notification);
            saveData();
            
            alert('ƒê√£ x√°c nh·∫≠n tr·∫£ s√°ch!');
            showBorrowed();
        }

        function showNotifications() {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            const myNotifications = notifications.filter(n => n.userId === currentUser.userId);
            
            const contentArea = document.querySelector('.content-area');
            contentArea.innerHTML = `
                <div style="background:white; padding:30px; border-radius:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2>Th√¥ng b√°o (${myNotifications.length})</h2>
                        <button class="btn btn-secondary" onclick="markAllAsRead()">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc t·∫•t c·∫£</button>
                    </div>
                    <div id="notificationList"></div>
                </div>
            `;
            
            const notificationList = document.getElementById('notificationList');
            
            if (myNotifications.length === 0) {
                notificationList.innerHTML = '<p style="color:#6b7280; text-align:center; padding:40px;">Kh√¥ng c√≥ th√¥ng b√°o n√†o</p>';
                return;
            }
            
            notificationList.innerHTML = myNotifications.reverse().map(n => `
                <div class="notification-item ${n.isRead ? '' : 'unread'}" onclick="markAsRead('${n.notificationId}')">
                    <p style="margin-bottom:5px;">${n.message}</p>
                    <small style="color:#6b7280;">${new Date(n.createdAt).toLocaleString('vi-VN')}</small>
                </div>
            `).join('');
        }

        function markAsRead(notificationId) {
            const notification = notifications.find(n => n.notificationId === notificationId);
            notification.isRead = true;
            saveData();
            updateNotificationBadge();
            showNotifications();
        }

        function markAllAsRead() {
            notifications.forEach(n => {
                if (n.userId === currentUser.userId) {
                    n.isRead = true;
                }
            });
            saveData();
            updateNotificationBadge();
            showNotifications();
        }

        function showProfile() {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }
            
            const myBooks = books.filter(b => b.ownerId === currentUser.userId);
            const myTransactions = transactions.filter(t => 
                t.requesterId === currentUser.userId || t.ownerId === currentUser.userId
            );
            
            const facultyText = {
                'CNTT': 'C√¥ng ngh·ªá th√¥ng tin',
                'KT': 'Kinh t·∫ø',
                'NN': 'Ngo·∫°i ng·ªØ',
                'SP': 'S∆∞ ph·∫°m'
            };
            
            const contentArea = document.querySelector('.content-area');
            contentArea.innerHTML = `
                <div style="background:white; padding:30px; border-radius:15px;">
                    <div style="text-align:center; margin-bottom:30px;">
                        <div style="width:100px; height:100px; border-radius:50%; background:var(--primary); display:flex; align-items:center; justify-content:center; color:white; font-size:40px; font-weight:700; margin:0 auto 20px;">
                            ${currentUser.fullName.charAt(0)}
                        </div>
                        <h2>${currentUser.fullName}</h2>
                        <p style="color:#6b7280; margin-top:5px;">${currentUser.email}</p>
                        <p style="color:#6b7280;">M√£ SV: ${currentUser.studentId}</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${myBooks.length}</div>
                            <div class="stat-label">S√°ch ƒë√£ ƒëƒÉng</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${myTransactions.length}</div>
                            <div class="stat-label">Giao d·ªãch</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${currentUser.trustScore}/5.0</div>
                            <div class="stat-label">ƒê√°nh gi√°</div>
                        </div>
                    </div>
                    
                    <div style="margin-top:30px;">
                        <h3 style="margin-bottom:15px;">Th√¥ng tin c√° nh√¢n</h3>
                        <div style="display:grid; gap:15px;">
                            <div style="padding:15px; background:var(--light); border-radius:8px;">
                                <strong>Khoa:</strong> ${facultyText[currentUser.faculty]}
                            </div>
                            <div style="padding:15px; background:var(--light); border-radius:8px;">
                                <strong>Vai tr√≤:</strong> ${currentUser.role === 'ADMIN' ? 'Qu·∫£n tr·ªã vi√™n' : 'Sinh vi√™n'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showAdmin() {
            if (!currentUser || currentUser.role !== 'ADMIN') {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!');
                return;
            }
            
            const contentArea = document.querySelector('.content-area');
            contentArea.innerHTML = `
                <div style="background:white; padding:30px; border-radius:15px;">
                    <h2 style="margin-bottom:20px;">Qu·∫£n tr·ªã h·ªá th·ªëng</h2>
                    
                    <div class="stats-grid" style="margin-bottom:30px;">
                        <div class="stat-card">
                            <div class="stat-value">${users.length}</div>
                            <div class="stat-label">Ng∆∞·ªùi d√πng</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${books.length}</div>
                            <div class="stat-label">S√°ch</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${transactions.length}</div>
                            <div class="stat-label">Giao d·ªãch</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${notifications.length}</div>
                            <div class="stat-label">Th√¥ng b√°o</div>
                        </div>
                    </div>
                    
                    <div style="display:grid; gap:20px;">
                        <div>
                            <h3 style="margin-bottom:15px;">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h3>
                            <div id="userList"></div>
                        </div>
                        
                        <div>
                            <h3 style="margin-bottom:15px;">Qu·∫£n l√Ω s√°ch</h3>
                            <div id="adminBookList"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Display users
            const userList = document.getElementById('userList');
            userList.innerHTML = users.map(u => `
                <div style="padding:15px; border:2px solid var(--border); border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${u.fullName}</strong> (${u.studentId})
                        <br>
                        <small style="color:#6b7280;">${u.email} - ${u.role}</small>
                    </div>
                    <div style="display:flex; gap:10px;">
                        ${u.role !== 'ADMIN' ? `
                            <button class="btn btn-warning" style="padding:8px 16px; font-size:12px;" onclick="toggleUserStatus('${u.userId}')">
                                ${u.isBlocked ? 'M·ªü kh√≥a' : 'Kh√≥a'}
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            // Display books
            const adminBookList = document.getElementById('adminBookList');
            adminBookList.innerHTML = books.map(b => {
                const owner = users.find(u => u.userId === b.ownerId);
                return `
                    <div style="padding:15px; border:2px solid var(--border); border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong>${b.title}</strong>
                            <br>
                            <small style="color:#6b7280;">Ch·ªß: ${owner ? owner.fullName : 'Unknown'} - Tr·∫°ng th√°i: ${b.status}</small>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-secondary" style="padding:8px 16px; font-size:12px;" onclick="toggleBookVisibility('${b.bookId}')">
                                ${b.isVisible ? '·∫®n' : 'Hi·ªán'}
                            </button>
                            <button class="btn btn-danger" style="padding:8px 16px; font-size:12px;" onclick="adminDeleteBook('${b.bookId}')">
                                X√≥a
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleUserStatus(userId) {
            const user = users.find(u => u.userId === userId);
            user.isBlocked = !user.isBlocked;
            saveData();
            alert(user.isBlocked ? 'ƒê√£ kh√≥a ng∆∞·ªùi d√πng!' : 'ƒê√£ m·ªü kh√≥a ng∆∞·ªùi d√πng!');
            showAdmin();
        }

        function toggleBookVisibility(bookId) {
            const book = books.find(b => b.bookId === bookId);
            book.isVisible = !book.isVisible;
            saveData();
            alert(book.isVisible ? 'ƒê√£ hi·ªán s√°ch!' : 'ƒê√£ ·∫©n s√°ch!');
            showAdmin();
        }

        function adminDeleteBook(bookId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s√°ch n√†y?')) {
                const index = books.findIndex(b => b.bookId === bookId);
                books.splice(index, 1);
                saveData();
                alert('ƒê√£ x√≥a s√°ch!');
                showAdmin();
            }
        }

        function deleteBook(bookId) {
            if (!currentUser) return;
            
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s√°ch n√†y?')) {
                const index = books.findIndex(b => b.bookId === bookId);
                books.splice(index, 1);
                saveData();
                alert('ƒê√£ x√≥a s√°ch!');
                closeModal('bookDetailModal');
                showMyBooks();
            }
        }

        function editBook(bookId) {
            alert('Ch·ª©c nƒÉng s·ª≠a s√°ch ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // ESC to close modals
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
            
            // Ctrl/Cmd + K to focus search
            if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                event.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });

        // Auto-save reminder
        setInterval(function() {
            if (currentUser) {
                console.log('üîÑ Auto-saving data...');
                saveData();
            }
        }, 60000); // Save every minute

        console.log('‚úÖ DNU BookShare loaded successfully!');
        console.log('üìä Statistics:', {
            users: users.length,
            books: books.length,
            transactions: transactions.length,
            notifications: notifications.length
        });
    </script>
</body>
</html>